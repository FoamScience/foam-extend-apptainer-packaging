# ---------------------------------------------------------------------------
#
# Create Foam-Extend-based AMR/LB image
#
# Build
#   apptainer build 
#             --build-arg REPO_USER=$BITBUCKET_USER
#             --build-arg REPO_TOKEN=$BITBUCKET_TOKEN
#             amrlb.sif amrlb.def
#
# Note
#   apptainer version 1.3.1
#
# ---------------------------------------------------------------------------
Bootstrap: localimage
From: fe-{{ FE_VERSION }}-{{ FE_BRANCH }}-ubuntu-{{ UBUNTU_VERSION }}-ompi-{{ OMPI_VERSION }}.sif

%arguments
    UBUNTU_VERSION=24.04
    FE_VERSION=5.0
    FE_BRANCH=master
    OMPI_VERSION=4.1.5

%post
    echo "Installing AMR/LB dependencies"
    git clone --branch dev --depth 1 https://{{ REPO_USER }}:{{ REPO_TOKEN }}@bitbucket.org/{{ REPO_USER }}/amrloadbalancing /opt/amrloadbalancing
    cd /opt/amrloadbalancing && git log
    /bin/bash -c 'source /opt/foam/foam-extend-{{ FE_VERSION }}/etc/bashrc; cd /opt/amrloadbalancing; ./Allwmake'
