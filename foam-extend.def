# ---------------------------------------------------------------------------
#
# Create Ubuntu-based Foam-Extend image
#
# Build
#   apptainer build --build-arg FE_VERSION=5.0 fe5.sif foam-extend.def
#
# Note
#   apptainer version 1.3.1
#
# ---------------------------------------------------------------------------
Bootstrap: docker
From: ubuntu:{{ UBUNTU_VERSION }}

%arguments
    UBUNTU_VERSION=24.04
    FE_VERSION=5.0
    FE_BRANCH=master
    OMPI_VERSION=4.1.5

%post
    DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get -y install --no-install-recommends \
        binutils-dev cmake flex zlib1g-dev libncurses-dev curl bison libbison-dev libfl-dev \
        python3 libpython3-dev libxt-dev rpm mercurial \
        apt-utils vim-tiny nano-tiny git ca-certificates \
        gcc g++ gfortran make file bzip2 patch libmetis-dev libscotch-dev libparmetis-dev
    export OMPI_VERSION={{ OMPI_VERSION }}
    ompi_short=$(echo {{ OMPI_VERSION }} | cut -d '.' -f1-2)
    export OMPI_URL="https://download.open-mpi.org/release/open-mpi/v$ompi_short/openmpi-{{ OMPI_VERSION }}.tar.bz2"
    export OMPI_DIR=/opt/ompi
    mkdir -p $OMPI_DIR /tmp/ompi
    cd /tmp/ompi && curl -O $OMPI_URL && tar -xjf openmpi-$OMPI_VERSION.tar.bz2
    cd /tmp/ompi/openmpi-$OMPI_VERSION && ./configure --prefix=$OMPI_DIR && make -j$(nproc) install
    export PATH=$OMPI_DIR/bin:$PATH
    export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH
    mkdir -p /opt/foam
    git clone --single-branch --branch {{ FE_BRANCH }} --depth 1 \
        git://git.code.sf.net/p/foam-extend/foam-extend-{{ FE_VERSION }} \
        /opt/foam/foam-extend-{{ FE_VERSION }}
    sed -i 's|^foamInstall.*|foamInstall=/opt/foam|' /opt/foam/foam-extend-{{ FE_VERSION }}/etc/bashrc
    nProcs=$(nproc)
    /bin/bash -c "cd /opt/foam/foam-extend-{{ FE_VERSION }} && source etc/bashrc && ./Allwmake.firstInstall -j $nProcs"

%runscript
    /bin/bash -c 'cd /opt/foam/foam-extend-{{ FE_VERSION }} && source etc/bashrc && mkdir -p $FOAM_USER_LIBBIN && mkdir -p $FOAM_USER_APPBIN'
    if [ $# -eq 0 ]; then
        /bin/bash -c "source /opt/foam/foam-extend-{{ FE_VERSION }}/etc/bashrc && /bin/bash --login"
    else
        /bin/bash -c "source /opt/foam/foam-extend-{{ FE_VERSION }}/etc/bashrc && $@"
    fi

%environment
    export OMPI_DIR=/opt/ompi
    export PATH="$OMPI_DIR/bin:$PATH"
    export LD_LIBRARY_PATH="$OMPI_DIR/lib:$LD_LIBRARY_PATH"
    export MANPATH="$OMPI_DIR/share/man:$MANPATH"
    export SHELL=/bin/bash

%labels
    Maintainer="Mohammed Elwardi Fadeli"
