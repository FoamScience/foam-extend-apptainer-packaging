# ---------------------------------------------------------------------------
#
# Create ESI OpenFOAM-based test image for OpenMPI
#
# Build
#   apptainer build test.sif test.def
#
# Note
#   apptainer version 1.3.1
#
# ---------------------------------------------------------------------------
Bootstrap: localimage
From: containers/com-openfoam-{{ OF_VERSION }}-{{ OF_BRANCH }}-ubuntu-{{ UBUNTU_VERSION }}-ompi-{{ OMPI_VERSION }}.sif

%arguments
    UBUNTU_VERSION=24.04
    OMPI_VERSION=4.1.5
    OF_VERSION=2312
    OF_BRANCH=default

%files
    OMPIFoam /opt/OMPIFoam

%post
    echo "Testing OpenMPI implementation"
    /bin/bash -c "cd /opt/OMPIFoam && mpicc -o ompiTest testOMPI.cpp"
    /bin/bash -c "source /usr/lib/openfoam/openfoam{{ OF_VERSION }}/etc/bashrc && cd /opt/OMPIFoam && wmake"
    jq --arg app test \
        '.[$app] |= if . == null then
        {
            ompi_test_bin: "/opt/OMPIFoam/ompiTest",
            foam_test_bin: "/opt/OMPIFoam/testOMPIFoam"
        }
        else . +
        {
            ompi_test_bin: "/opt/OMPIFoam/ompiTest",
            foam_test_bin: "/opt/OMPIFoam/testOMPIFoam"
        } end' /apps.json > /tmp/apps.json
    mv /tmp/apps.json /apps.json

%labels
    Description Test applications for ESI OpenFOAM
